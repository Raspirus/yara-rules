rule R3C0NST_Exploit_Outlook_CVE_2023_23397 : CVE_2023_23397 FILE
{
	meta:
		description = "Detects Outlook appointments exploiting CVE-2023-23397"
		author = "Frank Boldewin"
		id = "7e355e5f-93ca-561d-9a12-f73f1d429e4d"
		date = "2023-03-19"
		modified = "2023-03-25"
		reference = "https://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/"
		source_url = "https://github.com/fboldewin/YARA-rules//blob/54e9e6899b258b72074b2b4db6909257683240c2/Exploit_Outlook_CVE_2023_23397.yar#L1-L30"
		license_url = "N/A"
		logic_hash = "1847e8223b2f6d3ec5108e15ee46ef031ee1e26d3a5e8ed4a70c77b031f6a5b6"
		score = 75
		quality = 86
		tags = "CVE-2023-23397, FILE"
		Author = "Frank Boldewin (@r3c0nst)"
		Hash1 = "078b5023cae7bd784a84ec4ee8df305ee7825025265bf2ddc1f5238c3e432f5f"
		Hash2 = "a034427fd8524fd62380c881c30b9ab483535974ddd567556692cffc206809d1"
		Hash3 = "e7a1391dd53f349094c1235760ed0642519fd87baf740839817d47488b9aef02"
		Hash4 = "1543677037fa339877e1d6ef2d077f94613afbcd6434d7181a18df74aca7742b"

	strings:
		$ipmtask = "IPM.Task" wide ascii
		$ipmappointment = "IPM.Appointment" wide ascii
		$ipmtaskb64 = "IPM.Task" base64 base64wide
		$ipmappointmentb64 = "IPM.Appointment" base64 base64wide
		$unc_path1 = { 5C 00 5C 00 (3? 00 2E|3? 00 3? 00 2E|3? 00 3? 00 3? 00 2E) 00 (3? 00 2E|3? 00 3? 00 2E|3? 00 3? 00 3? 00 2E) 00 (3? 00 2E|3? 00 3? 00 2E|3? 00 3? 00 3? 00 2E) 00 (3? 00|3? 00 3? 00|3? 00 3? 00 3? 00) }
		$unc_path2 = { 5C 5C (3? 2E|3? 3? 2E|3? 3? 3? 2E) (3? 2E|3? 3? 2E|3? 3? 3? 2E) (3? 2E|3? 3? 2E|3? 3? 3? 2E) (3?|3? 3?|3? 3? 3?) }
		$unc_a = "\x00\x00\x00\x5c\x5c" base64
		$unc_w = "\x00\x00\x5c\x00\x5c" base64wide
		$mail1 = "from:" ascii wide nocase
		$mail2 = "received:" ascii wide nocase

	condition:
		(( uint32be(0)==0xD0CF11E0 or uint32be(0)==0x789F3E22) or ( all of ($mail*))) and (($ipmtask or $ipmappointment) or ($ipmtaskb64 or $ipmappointmentb64)) and (($unc_path1 or $unc_path2) or ($unc_a or $unc_w))
}
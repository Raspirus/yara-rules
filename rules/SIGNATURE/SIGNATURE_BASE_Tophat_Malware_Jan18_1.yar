import "pe"


rule SIGNATURE_BASE_Tophat_Malware_Jan18_1 : FILE
{
	meta:
		description = "Detects malware from TopHat campaign"
		author = "Florian Roth (Nextron Systems)"
		id = "ec290eee-a21e-548d-b7cc-3e25e7c39d22"
		date = "2018-01-29"
		modified = "2023-12-05"
		reference = "https://researchcenter.paloaltonetworks.com/2018/01/unit42-the-tophat-campaign-attacks-within-the-middle-east-region-using-popular-third-party-services/#appendix"
		source_url = "https://github.com/Neo23x0/signature-base/blob/6b8e2a00e5aafcfcfc767f3f53ae986cf81f968a/yara/apt_tophat.yar#L13-L36"
		license_url = "https://github.com/Neo23x0/signature-base/blob/6b8e2a00e5aafcfcfc767f3f53ae986cf81f968a/LICENSE"
		logic_hash = "69a1e1105b28d66203f74e68038efacc926e501e28a73865485adf2fd7fc0ac0"
		score = 75
		quality = 85
		tags = "FILE"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		hash1 = "5c0b253966befd57f4d22548f01116ffa367d027f162514c1b043a747bead596"
		hash2 = "1f9bca1d5ce5d14d478d32f105b3ab5d15e1c520bde5dfca22324262e84d4eaf"

	strings:
		$s1 = "WINMGMTS:\\\\.\\ROOT\\CIMV2" fullword ascii
		$s2 = "UENCRYPTION" fullword ascii
		$s3 = "TEXPORTAPIS" fullword ascii
		$s4 = "tcustommemorystream" fullword ascii
		$s5 = "tmemorystream" fullword ascii
		$s6 = "ExtrasNoteCONSOLEemb" fullword ascii
		$s7 = "DIALOG INCLUDE" fullword ascii

	condition:
		uint16(0)==0x5a4d and filesize <400KB and (pe.imphash()=="c221006b240b1c993217bd61e5ee31b6" or 6 of them )
}
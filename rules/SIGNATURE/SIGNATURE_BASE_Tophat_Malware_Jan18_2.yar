rule SIGNATURE_BASE_Tophat_Malware_Jan18_2 : FILE
{
	meta:
		description = "Auto-generated rule - file e.exe"
		author = "Florian Roth (Nextron Systems)"
		id = "a1b8e477-df8a-5ff4-9108-541a0f082f77"
		date = "2018-01-29"
		modified = "2023-01-06"
		reference = "https://researchcenter.paloaltonetworks.com/2018/01/unit42-the-tophat-campaign-attacks-within-the-middle-east-region-using-popular-third-party-services/#appendix"
		source_url = "https://github.com/Neo23x0/signature-base/blob/6b8e2a00e5aafcfcfc767f3f53ae986cf81f968a/yara/apt_tophat.yar#L38-L60"
		license_url = "https://github.com/Neo23x0/signature-base/blob/6b8e2a00e5aafcfcfc767f3f53ae986cf81f968a/LICENSE"
		logic_hash = "2321e89559363c04ef0e92a9c9e03d11ff27410103b3aaba954b544e33961b2f"
		score = 75
		quality = 85
		tags = "FILE"
		license = "Detection Rule License 1.1 https://github.com/Neo23x0/signature-base/blob/master/LICENSE"
		hash1 = "9580d15a06cd59c01c59bca81fa0ca8229f410b264a38538453f7d97bfb315e7"

	strings:
		$s1 = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\FontSubstitutes" fullword ascii
		$s2 = "\\SYSTEM\\CurrentControlSet\\Control\\Keyboard Layouts\\" ascii
		$s3 = "LError loading dock zone from the stream. Expecting version %d, but found %d." fullword wide
		$s4 = "WINMGMTS:\\\\.\\ROOT\\CIMV2" fullword ascii
		$s5 = "UENCRYPTION" fullword ascii
		$s6 = "TEXPORTAPIS" fullword ascii

	condition:
		uint16(0)==0x5a4d and filesize <1000KB and (pe.imphash()=="f98cebcae832abc3c46e6e296aecfc03" and 5 of them )
}
rule DITEKSHEN_MALWARE_Win_Commonmagic : FILE
{
	meta:
		description = "Detects CommonMagic and Modules"
		author = "ditekSHen"
		id = "cbebe334-9b66-5931-8f92-25d080f7fd6a"
		date = "2024-05-28"
		modified = "2024-05-28"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/yara/malware.yar#L9663-L9678"
		license_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/LICENSE.txt"
		logic_hash = "e94ba53f31f3effe12b1fbaca19fea59c0e12f742f6fc0af2a0a679bf4299cbe"
		score = 75
		quality = 75
		tags = "FILE"

	strings:
		$p1 = "\\\\.\\pipe\\PipeMd" wide
		$p2 = "\\\\.\\pipe\\PipeCrDtMd" wide
		$p3 = "\\\\.\\pipe\\PipeDtMd" wide
		$s1 = "graph.microsoft.com" fullword wide
		$s2 = "CreateNamedPipe" ascii
		$s3 = "\\CommonCommand\\" wide
		$ua1 = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36" wide
		$ua2 = "Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.135 Safari/537.36 Edge/12.10136" wide

	condition:
		uint16(0)==0x5a4d and (2 of ($p*) and 1 of ($s*)) or (1 of ($ua*) and 1 of ($s*) and 1 of ($p*))
}
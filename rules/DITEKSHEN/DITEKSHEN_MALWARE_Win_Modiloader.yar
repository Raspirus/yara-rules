import "pe"


rule DITEKSHEN_MALWARE_Win_Modiloader : FILE
{
	meta:
		description = "Detects ModiLoader"
		author = "ditekSHen"
		id = "2b3fd8ec-b672-574b-9b50-1a9ca9f43299"
		date = "2024-05-28"
		modified = "2024-05-28"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/yara/malware.yar#L10199-L10236"
		license_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/LICENSE.txt"
		logic_hash = "fc006377e6d41515503b0b234ff87f59d930a7d9f8b32d2e072de79b9c52ddc4"
		score = 75
		quality = 71
		tags = "FILE"

	strings:
		$x1 = "*()%@5YT!@#G__T@#$%^&*()__#@$#57$#!@" fullword wide
		$x2 = "dntdll" fullword wide
		$x3 = "USERPROFILE" fullword wide
		$s1 = "%s, ProgID: \"%s\"" ascii
		$s2 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ascii
		$s3 = "responsetext" ascii
		$s4 = "C:\\Users\\Public\\" ascii
		$s5 = "[InternetShortcut]" fullword ascii
		$c1 = "start /min powershell -WindowStyle Hidden -inputformat none -outputformat none -NonInteractive -Command \"Add-MpPreference -ExclusionPath 'C:\\Users'\" & exit" ascii nocase
		$c2 = "mkdir \"\\\\?\\C:\\Windows \"" ascii nocase
		$c3 = "mkdir \"\\\\?\\C:\\Windows \\System32\"" ascii nocase
		$c4 = "ECHO F|xcopy \"" ascii nocase
		$c5 = "\"C:\\Windows \\System32\" /K /D /H /Y" ascii nocase
		$c6 = "ping 127.0.0.1 -n 6 > nul" ascii nocase
		$c7 = "del /q \"C:\\Windows \\System32\\*\"" ascii nocase
		$c8 = "rmdir \"C:\\Windows \\System32\"" ascii nocase
		$c9 = "rmdir \"C:\\Windows \"" ascii nocase
		$g1 = "powershell" ascii nocase
		$g2 = "mkdir \"\\\\?\\C:\\" ascii nocase
		$g3 = "\" /K /D /H /Y" ascii nocase
		$g4 = "ping 127.0.0.1 -n" ascii nocase
		$g5 = "del /q \"" ascii nocase
		$g6 = "rmdir \"" ascii nocase

	condition:
		uint16(0)==0x5a4d and ((2 of ($x*) and ( all of ($g*) or (2 of ($s*) and 2 of ($c*)))) or ( all of ($s*) and (2 of ($c*) or all of ($g*))) or (4 of ($c*) and (1 of ($x*) or 2 of ($s*))) or ( all of ($g*) and 4 of ($c*)) or 13 of them )
}
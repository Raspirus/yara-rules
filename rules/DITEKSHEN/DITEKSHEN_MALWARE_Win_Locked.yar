rule DITEKSHEN_MALWARE_Win_Locked : FILE
{
	meta:
		description = "Detects Locked ransomware"
		author = "ditekSHen"
		id = "ad2f91ab-9bbb-5d47-a5c3-5a38dbab2ebe"
		date = "2024-05-28"
		modified = "2024-05-28"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/yara/malware.yar#L9116-L9132"
		license_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/LICENSE.txt"
		logic_hash = "b838b996946fb268c66bac68d5e326ff3049340dfb08f2e0a77492df49915d5a"
		score = 75
		quality = 73
		tags = "FILE"

	strings:
		$x1 = "http://xxxx.onion/xxxx-xxxx-xxxx-xxxx" ascii
		$x2 = "http://pigetrzlperjreyr3fbytm27bljaq4eungv3gdq2tohnoyfrqu4bx5qd.onion" ascii
		$x3 = "dHA6Ly94eHh4Lm9uaW9uL3h4eHgteHh4eC14eHh4LXh4eHg" ascii
		$s1 = "choice /t 1 /d y /n >nul" ascii
		$s2 = ".locked" fullword ascii
		$s3 = "c:\\system volume information" fullword ascii
		$s4 = "__$$RECOVERY_README$$__.html" fullword ascii
		$s5 = "Trunc..." fullword ascii
		$s6 = /C:\\windows\\temp\\[a-z0-9A-Z]{6}\.tmp/ fullword ascii

	condition:
		uint16(0)==0x5a4d and ( all of ($x*) or all of ($s*) or (1 of ($x*) and 4 of ($s*)) or (#s6>1 and 4 of them ))
}
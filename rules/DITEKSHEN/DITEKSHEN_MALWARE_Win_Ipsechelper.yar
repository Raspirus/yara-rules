import "pe"


rule DITEKSHEN_MALWARE_Win_Ipsechelper : FILE
{
	meta:
		description = "Detects IPsecHelper backdoor"
		author = "ditekSHen"
		id = "f848ac2a-95ad-596a-b193-5cfb424e33a2"
		date = "2024-05-28"
		modified = "2024-05-28"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/yara/malware.yar#L6256-L6279"
		license_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/LICENSE.txt"
		logic_hash = "be0ecf8a97d289b15b902420d769925b7b22ab835bd7d10d10b059119f41e540"
		score = 75
		quality = 75
		tags = "FILE"

	strings:
		$s1 = "rundll32.exe advapi32.dll,ProcessIdleTasks" wide
		$s2 = "CommandExecute" fullword ascii
		$s3 = "DownloadExecuteUrl" fullword ascii
		$s4 = "DownloadExecuteFile" fullword ascii
		$s5 = "CmdExecute" fullword ascii
		$s6 = "ExecuteProcessWithResult" fullword ascii
		$s7 = "IsFirstInstance ==> checked" fullword wide
		$s8 = "del \"%PROG%%SERVICENAME%\".*" fullword wide
		$s9 = ".CreateConfig" wide
		$s10 = ".SelfDelete" wide
		$c1 = "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; EmbeddedWB 14.52 from: http://www.google.com/ EmbeddedWB 14.52;" wide
		$c2 = "boot.php" wide
		$c3 = "lastupdate.php" wide
		$c4 = "main.php" wide
		$c5 = "InternetNeeded" wide
		$c6 = "DeviceIdSalt" wide

	condition:
		uint16(0)==0x5a4d and (6 of ($s*) or 4 of ($c*) or 8 of them )
}
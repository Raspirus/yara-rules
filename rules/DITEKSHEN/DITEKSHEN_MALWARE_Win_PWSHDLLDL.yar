import "pe"


rule DITEKSHEN_MALWARE_Win_PWSHDLLDL : FILE
{
	meta:
		description = "Detects downloader"
		author = "ditekShen"
		id = "553ed216-c8c2-504f-b689-0e8d21a00eaa"
		date = "2024-05-28"
		modified = "2024-05-28"
		reference = "https://github.com/ditekshen/detection"
		source_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/yara/malware.yar#L11306-L11321"
		license_url = "https://github.com/ditekshen/detection/blob/2ddbbe14eea1f342bca2cfd09a643a40ae2fcaf6/LICENSE.txt"
		logic_hash = "7acef81f0e6e282650c161963599dcbe2b3975d482eb7c330581901b0fe85655"
		score = 75
		quality = 75
		tags = "FILE"

	strings:
		$s1 = "powershell.exe Set-ExecutionPolicy Bypass -Scope Process ; powershell -file " fullword wide nocase
		$s2 = "objShell.run \"powershell -WindowStyle hidden -command wscript.exe //b //nologo '" fullword wide nocase
		$s3 = "cmd.exe /c schtasks.exe /create /tn \"" fullword wide nocase
		$s4 = "-WindowStyle hidden -command wscript.exe //b //nologo '" fullword wide nocase
		$s6 = "\" /tr \"wscript.exe //b //nologo '" fullword wide nocase
		$s7 = "\" -Value \"Powershell.exe -WindowStyle hidden \"\"& '" fullword wide nocase
		$op0 = { 61 01 00 34 53 79 73 74 65 6d 2e 57 65 62 2e 53 }
		$op1 = { 4b 04 00 00 34 01 00 00 7f 05 00 00 1a }

	condition:
		uint16(0)==0x5a4d and pe.is_dll() and 5 of them
}